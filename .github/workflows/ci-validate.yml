name: Snowflake CI Pipeline (STAGE - FINAL DEBUGGED)

on:
  push:
    branches:
      - stage

jobs:
  deploy-to-stage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install schemachange
        run: pip install schemachange

      - name: Create connections.toml using ENV (no quotes!)
        env:
          SNOWFLAKE_USER: VIRAJVJ8815
          SNOWFLAKE_PASSWORD: Viraj@1234567890
          SNOWFLAKE_ACCOUNT: jx18523.south-central-us.azure
          SNOWFLAKE_ROLE: ACCOUNTADMIN
          SNOWFLAKE_WAREHOUSE: COMPUTE_WH
          SNOWFLAKE_DATABASE: STAGE_DB
          SNOWFLAKE_SCHEMA: PUBLIC
        run: |
          echo "[connections.default]" > connections.toml
          echo user = ${SNOWFLAKE_USER} >> connections.toml
          echo password = ${SNOWFLAKE_PASSWORD} >> connections.toml
          echo account = ${SNOWFLAKE_ACCOUNT} >> connections.toml
          echo role = ${SNOWFLAKE_ROLE} >> connections.toml
          echo warehouse = ${SNOWFLAKE_WAREHOUSE} >> connections.toml
          echo database = ${SNOWFLAKE_DATABASE} >> connections.toml
          echo schema = ${SNOWFLAKE_SCHEMA} >> connections.toml

      - name: Show raw connections.toml (no mask)
        run: |
          echo "----------- RAW TOML ------------"
          cat connections.toml
          echo "---------------------------------"

      - name: Run schemachange on STAGE_DB
        run: |
          schemachange -f sql --create-change-history-table
